import{x as e,n as a,q as l,r as t,o as i,d as n,w as o,i as d,c as s,e as u,z as r,h as m,f as c,t as p,A as f,g as y,F as v,C as g,D as b,v as T}from"./index-om00KmGp.js";import{S as h}from"./sortable.esm-CG_H93Kl.js";import{u as x}from"./useFormState-BETjqvZH.js";import{H as C,u as k}from"./HolderOutlined-Cbpjs_SM.js";const w=a=>e.post("/biSetting/frontSetting/enable",a),L={class:"flex items-center"},N=d("span",{style:{width:"100px","text-align":"right"}},"前台表表名：",-1),_={class:"flex items-center gap-4"},S={key:0,class:"mr-8"},I={class:"flex flex-row items-center gap-2"},U={class:"",style:{color:"#999"}},O={class:"flex flex-col justify-center gap-2 pt-2 border-t"},j={class:"flex"},A={class:"flex flex-col justify-center gap-2 pt-2 border-t"},D={__name:"frontTableSet",setup(D){const{formState:q,patchFormState:K,resetFormState:R}=x({id:void 0,tableName:"qtbcs1",refTableList:[{refTableName:void 0,joinType:void 0,refCondition:void 0,refTableAlias:"A"}],columnList:[],timeCondition:void 0,groupCondition:void 0,status:1,deleted:void 0});let B=["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z"];const F=a(void 0),H=a(!1),J=async()=>{H.value=!0;const a=await(a=>e.post("/biSetting/frontSetting/checkTable",a))({tableName:q.tableName}),{code:l,data:t}=a;l||(t?b.info({title:"提示",content:"该表已存在，即将进行内容编辑",onOk:async()=>{H.value=!1,F.value=q.tableName,G(t)}}):b.info({title:"提示",content:"该表不存在，即将进行内容创建",onOk:async()=>{const a=await(a=>e.post("/biSetting/frontSetting/getDefaultColumn",a))(),{code:l,data:t}=a;l||(H.value=!1,F.value=q.tableName,G({tableName:q.tableName,columnList:t.columnList,refTableList:[{refTableName:void 0,joinType:void 0,refCondition:void 0,refTableAlias:"A"}]}))}}))},G=e=>{var a;K({id:e.id,tableName:e.tableName,refTableList:null==(a=e.refTableList)?void 0:a.map((e=>(B=B.filter((a=>a!==e.refTableAlias)),{refTableName:e.refTableName,joinType:e.joinType,refCondition:e.refCondition,refTableAlias:e.refTableAlias}))),columnList:e.columnList.map(((e,a)=>({id:k("frontTableSet_"),columnName:e.columnName,columnType:e.columnType??2,length:e.length??256,valueLogic:e.valueLogic,digitsTag:1===e.digitsTag,decimalDigits:e.decimalDigits,summaryType:e.columnSummary??5,isKey:1===e.pkTag}))),timeCondition:e.timeCondition,groupCondition:e.groupCondition.replace("GROUP BY ",""),status:e.status,deleted:e.deleted})},P=a(null),E=async()=>{if(await P.value.validate()){const a=await(a=>e.post("/biSetting/frontSetting/save",a))({id:q.id,tableName:q.tableName,refTableList:q.refTableList,columnList:q.columnList.map((e=>({columnName:e.columnName,columnType:e.columnType,length:e.length,valueLogic:e.valueLogic,digitsTag:e.digitsTag?1:0,decimalDigits:e.decimalDigits,columnSummary:e.summaryType,pkTag:e.isKey?1:0}))),timeCondition:q.timeCondition,groupCondition:"GROUP BY "+q.groupCondition}),{code:l,data:t}=a;l||(T.success("保存成功"),q.id=t.id||q.id)}},Y=async()=>{b.confirm({title:"提示",content:"是否停用该前台表",onOk:async()=>{const e=await w({id:q.id,status:0}),{code:a,data:l}=e;a||(T.success(`前台表${F.value}已停用`),q.status=0)}})},M=async()=>{b.confirm({title:"提示",content:"是否启用该前台表",onOk:async()=>{const e=await w({id:q.id,status:1}),{code:a,data:l}=e;a||(T.success(`前台表${F.value}已启用`),q.status=1)}})},z=()=>{q.refTableList.push({refTableName:"",joinType:1,refCondition:null,refTableAlias:B.shift()})};l((()=>{Q(),W(),new h(document.querySelector("#frontTableSetDragTable tbody"),{handle:".anticon-holder",animation:150,ghostClass:"blue-background-class",sort:!0,disabled:!1,async onEnd({newIndex:e,oldIndex:a}){const l=JSON.parse(JSON.stringify(q.columnList[a]));q.columnList.splice(a,1),q.columnList.splice(e,0,l)},onUpdate(e){}})}));const $=a([]),Q=async()=>{const a=await(a=>e.post("/biSetting/frontSetting/getColumnType",a))(),{code:l,data:t}=a;l||($.value=t)},V=a([]),W=async()=>{const a=await(a=>e.post("/biSetting/frontSetting/getSummaryType",a))(),{code:l,data:t}=a;l||(V.value=t)},X=[{label:"INNER JOIN",value:1},{label:"LEFT JOIN",value:2},{label:"RIGHT JOIN",value:3}],Z=[{title:"",dataIndex:"hold",width:20},{title:"列名",dataIndex:"columnName",key:"columnName",width:100,ellipsis:!0,editable:!0},{title:"类型",dataIndex:"columnType",key:"columnType",width:100,ellipsis:!0,editable:!0},{title:"长度",dataIndex:"length",key:"length",width:100,ellipsis:!0,editable:!0},{title:"值",dataIndex:"valueLogic",key:"valueLogic",width:200,ellipsis:!0,editable:!0},{title:"小数位",dataIndex:"digitsTag",key:"digitsTag",width:100,ellipsis:!0,editable:!0},{title:"列汇总",dataIndex:"summaryType",key:"summaryType",width:100,ellipsis:!0,editable:!0},{title:"",dataIndex:"action",key:"action",width:100,ellipsis:!0,editable:!0}];return(e,a)=>{const l=t("a-input"),b=t("a-button"),T=t("a-form-item"),h=t("a-select"),x=t("a-checkbox"),w=t("a-input-number"),D=t("a-form-item-rest"),K=t("a-table"),R=t("a-form"),G=t("a-spin"),Q=t("ListPage");return i(),n(Q,null,{tableTitle:o((()=>[d("div",L,[N,s(l,{value:u(q).tableName,"onUpdate:value":a[0]||(a[0]=e=>u(q).tableName=e),valueModifiers:{trim:!0},placeholder:"请输入",style:{width:"300px"},allowClear:"",onKeyup:r(J,["enter"])},null,8,["value"]),s(b,{class:"ml-2",type:"primary",onClick:J,loading:H.value,disabled:!u(q).tableName},{default:o((()=>[m(" 检测 ")])),_:1},8,["loading","disabled"])])])),actions:o((()=>[d("div",_,[F.value?(i(),c("span",S," 当前操作表："+p(F.value),1)):f("",!0),s(b,{type:"primary",onClick:E,disabled:!F.value},{default:o((()=>[m(" 保存 ")])),_:1},8,["disabled"]),F.value&&1===u(q).status?(i(),n(b,{key:1,type:"primary",onClick:Y},{default:o((()=>[m(" 停用 ")])),_:1})):f("",!0),F.value&&0===u(q).status?(i(),n(b,{key:2,type:"primary",onClick:M},{default:o((()=>[m(" 启用 ")])),_:1})):f("",!0)])])),table:o((({scrollHeight:e})=>[s(G,{spinning:H.value},{default:o((()=>[s(R,{ref_key:"frontTableRef",ref:P,model:u(q),name:"formState","label-col":{style:"width: 100px"},autocomplete:"off"},{default:o((()=>[d("div",{class:"flex flex-col gap-2 py-2 border-t overflow-auto",style:g({maxHeight:e+"px"})},[d("div",null,[(i(!0),c(v,null,y(u(q).refTableList,((e,a)=>(i(),c("div",I,[s(T,{name:["refTableList",a,"refTableName"],label:0===a?"选择主表":"选择关联表：",rules:{required:!0,message:"请选择"}},{default:o((()=>[s(l,{value:e.refTableName,"onUpdate:value":a=>e.refTableName=a,valueModifiers:{trim:!0},placeholder:"请输入",style:{width:"300px"},allowClear:""},{addonAfter:o((()=>[d("span",U," 别名："+p(e.refTableAlias),1)])),_:2},1032,["value","onUpdate:value"])])),_:2},1032,["name","label"]),a?(i(),n(T,{key:0,name:["refTableList",a,"refCondition"],label:"关联条件：",rules:{required:!0,message:"请输入"}},{default:o((()=>[s(l,{value:e.refCondition,"onUpdate:value":a=>e.refCondition=a,placeholder:"请输入",style:{width:"600px"},allowClear:""},{addonBefore:o((()=>[s(h,{value:e.joinType,"onUpdate:value":a=>e.joinType=a,placeholder:"请选择",style:{width:"150px"},options:X},null,8,["value","onUpdate:value"])])),_:2},1032,["value","onUpdate:value"]),a?(i(),n(b,{key:0,type:"text",danger:"",onClick:l=>((e,a)=>{B.push(a),B.sort(),q.refTableList.splice(e,1)})(a,e.refTableAlias)},{default:o((()=>[m("删除")])),_:2},1032,["onClick"])):f("",!0)])),_:2},1032,["name"])):f("",!0)])))),256)),s(b,{type:"dashed",onClick:z,style:{width:"1100px","margin-left":"10px"},disabled:!F.value},{default:o((()=>[m(" + 新增关联表 ")])),_:1},8,["disabled"])]),d("div",O,[s(T,{label:"设置列内容："},{default:o((()=>[s(K,{id:"frontTableSetDragTable",size:"small",columns:Z,"data-source":u(q).columnList,pagination:!1,"row-key":e=>e.id,class:"pr-4"},{bodyCell:o((({column:e,text:a,record:t,index:c})=>["hold"===e.dataIndex?(i(),n(T,{key:0},{default:o((()=>[s(u(C),{class:"hover:cursor-move"})])),_:1})):f("",!0),"action"===e.dataIndex?(i(),n(T,{key:1},{default:o((()=>[d("div",j,[s(b,{type:"text",style:{color:"#1890ff"},onClick:e=>(e=>{q.columnList.splice(e+1,0,{id:k("frontTableSet_"),columnName:void 0,columnType:void 0,length:void 0,valueLogic:void 0,digitsTag:!1,decimalDigits:void 0,summaryType:5,isKey:!1})})(c)},{default:o((()=>[m(" 新增 ")])),_:2},1032,["onClick"]),s(b,{type:"text",danger:"",onClick:e=>(e=>{q.columnList.splice(e,1)})(c),disabled:1===u(q).columnList.length||t.isKey},{default:o((()=>[m(" 删除 ")])),_:2},1032,["onClick","disabled"])])])),_:2},1024)):f("",!0),"columnName"===e.dataIndex?(i(),n(T,{key:2,name:["columnList",c,"columnName"],rules:{required:!0,message:"请输入"}},{default:o((()=>[s(l,{placeholder:"请输入",value:t.columnName,"onUpdate:value":e=>t.columnName=e,disabled:t.isKey,allowClear:""},null,8,["value","onUpdate:value","disabled"])])),_:2},1032,["name"])):f("",!0),"columnType"===e.dataIndex?(i(),n(T,{key:3,name:["columnList",c,"columnType"]},{default:o((()=>[s(h,{placeholder:"请选择",value:t.columnType,"onUpdate:value":e=>t.columnType=e,allowClear:"",rules:{required:!0,message:"请选择"},options:$.value,fieldNames:{label:"name",value:"id"}},null,8,["value","onUpdate:value","options"])])),_:2},1032,["name"])):f("",!0),"length"===e.dataIndex?(i(),n(T,{key:4,name:["columnList",c,"length"],rules:{required:3!==t.columnType,message:"请选择"}},{default:o((()=>[s(l,{placeholder:"请输入",value:t.length,"onUpdate:value":e=>t.length=e,allowClear:""},null,8,["value","onUpdate:value"])])),_:2},1032,["name","rules"])):f("",!0),"valueLogic"===e.dataIndex?(i(),n(T,{key:5,name:["columnList",c,"valueLogic"],rules:{required:!0,message:"请选择"}},{default:o((()=>[s(l,{id:"editableInput",ref:"editableInputRef",value:t[e.dataIndex],"onUpdate:value":a=>t[e.dataIndex]=a,placeholder:"请输入",allowClear:"",onKeydown:r((a=>{e.dataIndex}),["enter"])},null,8,["value","onUpdate:value","onKeydown"])])),_:2},1032,["name"])):f("",!0),"digitsTag"===e.dataIndex?(i(),n(T,{key:6,name:["columnList",c,"digitsTag"]},{default:o((()=>[s(x,{class:"ml-4",checked:t.digitsTag,"onUpdate:checked":e=>t.digitsTag=e,disabled:!t.columnType||t.isKey},null,8,["checked","onUpdate:checked","disabled"]),s(D,null,{default:o((()=>[s(w,{value:t.decimalDigits,"onUpdate:value":e=>t.decimalDigits=e,disabled:!t.digitsTag,min:0,max:6,class:"w-20 ml-4"},null,8,["value","onUpdate:value","disabled"])])),_:2},1024)])),_:2},1032,["name"])):f("",!0),"summaryType"===e.dataIndex?(i(),n(T,{key:7,name:["columnList",c,"summaryType"]},{default:o((()=>[s(h,{placeholder:"请选择",value:t.summaryType,"onUpdate:value":e=>t.summaryType=e,allowClear:"",options:V.value,fieldNames:{label:"name",value:"id"}},null,8,["value","onUpdate:value","options"])])),_:2},1032,["name"])):f("",!0)])),_:1},8,["data-source","row-key"])])),_:1})]),d("div",A,[d("div",null,[s(T,{label:"时间条件：",name:"timeCondition",rules:{required:!0,message:"请输入"}},{default:o((()=>[s(l,{value:u(q).timeCondition,"onUpdate:value":a[1]||(a[1]=e=>u(q).timeCondition=e),placeholder:"请输入",style:{width:"600px"},allowClear:""},null,8,["value"])])),_:1})]),d("div",null,[s(T,{label:"整合条件：",name:"groupCondition",rules:{required:!0,message:"请输入"}},{default:o((()=>[s(l,{value:u(q).groupCondition,"onUpdate:value":a[2]||(a[2]=e=>u(q).groupCondition=e),placeholder:"请输入",style:{width:"600px"},allowClear:""},{addonBefore:o((()=>[m(" GROUP BY ")])),_:1},8,["value"])])),_:1})])])],4)])),_:2},1032,["model"])])),_:2},1032,["spinning"])])),_:1})}}};export{D as default};
