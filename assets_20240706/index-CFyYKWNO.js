import{u as e}from"./useFormState-BETjqvZH.js";import{c as a,l,b as t,m as o,q as u,u as s}from"./dept-QqdgSadq.js";import{n as i,q as n,r,o as c,d,w as m,c as v,h as p,e as b,i as f,f as k,g as N,F as y,v as h,t as _,y as w,U as g,p as x,j as S,Q as C}from"./index-om00KmGp.js";import{_ as I}from"./_plugin-vue_export-helper-BCo6x5W8.js";const T={style:{width:"160px"}},F=f("div",null,null,-1),U=f("div",null,null,-1),V={__name:"search",emits:["search","reset","preview","autoMatch"],setup(l,{expose:t,emit:o}){const u=o,{formState:s,setFormState:w,resetFormState:g}=e({tableName:"",columnName:"",pkName:""}),x=()=>{u("autoMatch",s)},S=()=>{u("search",s)},C=()=>{g(),u("reset",s)},I=i(!1),V=i([]),j=async()=>{if(I.value=!0,s.tableName){const{data:e,code:l}=await a({tableName:s.tableName});l?V.value=[]:(V.value=e,h.success(`${s.tableName}表存在`)),I.value=!1}else I.value=!1,h.info("请输入表名后再检测")},M=()=>{u("preview",V.value)};return t({doSearch:S,formState:s}),n((()=>{})),(e,a)=>{const l=r("a-input"),t=r("a-button"),o=r("a-select-option"),u=r("a-select"),i=r("SearchContainer");return c(),d(i,{labelWidth:"100",limitRows:"1",noCollapse:""},{action:m((()=>[v(t,{onClick:x},{default:m((()=>[p("自动匹配")])),_:1}),v(t,{onClick:C},{default:m((()=>[p("重置")])),_:1}),v(t,{type:"primary",onClick:S},{default:m((()=>[p("查询")])),_:1})])),default:m((()=>[v(l,{label:"表名",placeholder:"请输入",value:b(s).tableName,"onUpdate:value":a[0]||(a[0]=e=>b(s).tableName=e),allowClear:""},null,8,["value"]),f("div",T,[v(t,{onClick:j,loading:I.value},{default:m((()=>[p("检测")])),_:1},8,["loading"]),v(t,{style:{"margin-left":"10px"},disabled:0===V.value.length,onClick:M},{default:m((()=>[p("预览")])),_:1},8,["disabled"])]),F,U,v(u,{label:"主键字段名",placeholder:"请选择",value:b(s).pkName,"onUpdate:value":a[1]||(a[1]=e=>b(s).pkName=e),allowClear:""},{default:m((()=>[(c(!0),k(y,null,N(V.value,(e=>(c(),d(o,{key:`pkName${e.columnName}`,value:e.columnName},{default:m((()=>[p(_(e.columnName),1)])),_:2},1032,["value"])))),128))])),_:1},8,["value"]),v(u,{label:"字段名",placeholder:"请选择",value:b(s).columnName,"onUpdate:value":a[2]||(a[2]=e=>b(s).columnName=e),allowClear:""},{default:m((()=>[(c(!0),k(y,null,N(V.value,(e=>(c(),d(o,{key:`columnName${e.columnName}`,value:e.columnName},{default:m((()=>[p(_(e.columnName),1)])),_:2},1032,["value"])))),128))])),_:1},8,["value"])])),_:1})}}},j=I({__name:"previewTable",props:{list:{type:Array,default:void 0},visible:{type:Boolean,default:!1}},emits:["update:visible","afterSave"],setup(e,{emit:a}){const l=e,t=a,o=w({get:()=>l.visible,set(e){t("update:visible",e)}});g((()=>{}));const u=[{title:"字段名称",dataIndex:"columnName",key:"columnName"},{title:"字段长度",dataIndex:"columnSize",key:"columnSize"},{title:"字段类型",dataIndex:"columnType",key:"columnType"},{title:"字段备注",dataIndex:"remark",key:"remark"}];return(a,l)=>{const t=r("a-table"),s=r("a-modal");return c(),d(s,{visible:o.value,"onUpdate:visible":l[0]||(l[0]=e=>o.value=e),title:"预览",footer:null,width:"60%",destroyOnClose:!0,maskClosable:!1},{default:m((()=>[v(t,{columns:u,"data-source":e.list,"row-key":e=>e.id,pagination:!1,scroll:{y:400},rowSelection:a.rowSelection,class:"mb-4"},null,8,["data-source","row-key","rowSelection"])])),_:1},8,["visible"])}}},[["__scopeId","data-v-9347afac"]]),M=(e=>(x("data-v-152ee9be"),e=e(),S(),e))((()=>f("div",{class:"title"},"对照",-1))),R={class:"grid grid-cols-1 gap-0"},z=I({__name:"compareModel",props:{compareValue:{type:Object,default:void 0},visible:{type:Boolean,default:!1}},emits:["matchTable"],setup(a,{emit:t}){const o=a,u=t,s=w({get:()=>o.visible,set(e){u("update:visible",e)}}),p=i(null),k=i({id:[{required:!0,message:"请选择部门",trigger:"blur"}]}),N=i([]),y=()=>{p.value.validate().then((async(e,a)=>{if(!e)return p.value.focusFirstField(),!1;{let e={localPkValue:_.id,tableName:o.compareValue.tableName,pkValue:o.compareValue.pk};u("match",e)}})).catch((e=>{}))},h=()=>{x(),s.value=!1,_.id=""},{formState:_,patchFormState:g,resetFormState:x}=e({id:void 0,name:void 0,description:void 0});return n((()=>{(async()=>{const{data:e}=await l();N.value=e||[]})()})),(e,a)=>{const l=r("a-tree-select"),t=r("a-form-item"),o=r("a-form"),u=r("a-modal");return c(),d(u,{visible:s.value,"onUpdate:visible":a[1]||(a[1]=e=>s.value=e),title:"对照",onOk:y,onCancel:h,okText:"对照",width:"40%",destroyOnClose:!0,maskClosable:!1},{default:m((()=>[v(o,{ref_key:"wordForm",ref:p,model:b(_),name:"compareVal","label-col":{style:{width:"80px"}},"wrapper-col":{span:16},autocomplete:"off",rules:k.value},{default:m((()=>[M,f("div",R,[v(t,{label:"选择部门",name:"id"},{default:m((()=>[v(l,{label:"部门名称",value:b(_).id,"onUpdate:value":a[0]||(a[0]=e=>b(_).id=e),style:{width:"100%"},"tree-data":N.value,fieldNames:{label:"deptName",value:"id",children:"children"},"allow-clear":"","search-placeholder":"请选择"},null,8,["value","tree-data"])])),_:1})])])),_:1},8,["model","rules"])])),_:1},8,["visible"])}}},[["__scopeId","data-v-152ee9be"]]),O={__name:"index",setup(e){const a=i([]),l=i(!1),n=i(),d=async e=>{if(e.tableName&&e.columnName&&e.pkName){l.value=!0;try{const t=await u(e),{code:o,data:s}=t;o?h.error(t.msg):a.value=s||[],l.value=!1}catch(t){a.value=[],h.error("获取数据失败"),l.value=!1}}else h.info("请先填入表名、字段名、主键名")},b=e=>{d(e)},f=(e={})=>{d(e)},N=async e=>{if(e.tableName&&e.columnName&&e.pkName){let a={columnName:e.columnName,pkName:e.pkName,tableName:e.tableName};const{data:l,code:o}=await t(a);b(a),o||h.success("自动匹配成功")}else h.info("请先填入表名、字段名、主键名")};i(null);const _=i(!1),w=i([]),g=e=>{w.value=e||[],_.value=!0},x=async e=>{let a={...e,pkName:n.value.formState.pkName,columnName:n.value.formState.columnName};const l=await o(a),{code:t}=l;t||(S.value=!1,h.success("对照成功"),n.value.doSearch())},S=i(!1),I=i({}),T=[{title:"表名",dataIndex:"tableName",key:"tableName"},{title:"主键",dataIndex:"pk",key:"pk"},{title:"字段名",dataIndex:"column",key:"column"},{title:"本地主键",dataIndex:"localPk",key:"localPk"},{title:"本地字段名",dataIndex:"localColumn",key:"localColumn"},{title:"匹配状态",dataIndex:"refTag",key:"refTag",customRender:({record:e})=>v("span",null,[1===e.refTag?"已对照":"未对照"])},{title:"操作",dataIndex:"action",key:"action",customRender:e=>0==e.record.refTag?v("div",{class:"flex flex-row gap-2"},[v(r("a-button"),{type:"link",size:"small",onClick:()=>(async({record:e})=>{I.value=e,S.value=!0})(e)},{default:()=>[p("对照")]})]):1==e.record.refTag?v(r("a-button"),{type:"link",size:"small",onClick:()=>(async({record:e})=>{let{data:a,code:l}=await s({pkValue:e.pk,tableName:e.tableName});l?h.error(a.msg):(h.success("取消对照成功"),n.value.doSearch())})(e),disabled:0===e.record.id},{default:()=>[p("取消对照")]}):void 0}];return(e,t)=>(c(),k(y,null,[v(C,{columns:T,tableTitle:"部门对照",tableData:a.value,loading:l.value},{search:m((()=>[v(V,{ref_key:"compareSearchRef",ref:n,onSearch:b,onReset:f,onPreview:g,onAutoMatch:N},null,512)])),_:1},8,["tableData","loading"]),v(j,{visible:_.value,"onUpdate:visible":t[0]||(t[0]=e=>_.value=e),list:w.value},null,8,["visible","list"]),v(z,{visible:S.value,"onUpdate:visible":t[1]||(t[1]=e=>S.value=e),compareValue:I.value,onMatch:x},null,8,["visible","compareValue"])],64))}};export{O as default};
