import{x as e,n as a,q as l,r as t,o as i,d as n,w as s,i as o,c as d,e as u,z as m,h as r,f as c,t as p,A as y,g as f,F as b,C as v,D as T,v as g}from"./index-om00KmGp.js";import{S as h}from"./sortable.esm-CG_H93Kl.js";import{u as C}from"./useFormState-BETjqvZH.js";import{H as x,u as N}from"./HolderOutlined-Cbpjs_SM.js";const k=a=>e.post("/biSetting/summarySetting/enable",a),w={class:"flex items-center"},S=o("span",{style:{width:"100px","text-align":"right"}},"汇总表表名：",-1),L={class:"flex items-center gap-4"},_={key:0,class:"mr-8"},U={class:"flex flex-row items-center gap-2"},A={class:"",style:{color:"#999"}},I={class:"flex flex-col justify-center gap-2 pt-2 border-t"},j={class:"flex"},O={class:"flex flex-col justify-center gap-2 pt-2 border-t"},q={__name:"summaryTableSet",setup(q){const{formState:K,patchFormState:H,resetFormState:B}=C({id:void 0,tableName:"hzbcs1",refTableList:[{refTableName:void 0,joinType:void 0,refCondition:void 0,refTableAlias:"A"}],columnList:[],timeCondition:void 0,groupCondition:void 0,status:1,deleted:void 0});let D=["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z"];const F=a(void 0),P=a(!1),R=async()=>{P.value=!0;const a=await(a=>e.post("/biSetting/summarySetting/checkTable",a))({tableName:K.tableName}),{code:l,data:t}=a;l||(t?T.info({title:"提示",content:"该表已存在，即将进行内容编辑",onOk:async()=>{P.value=!1,F.value=K.tableName,G(t)}}):T.info({title:"提示",content:"该表不存在，即将进行内容创建",onOk:async()=>{const a=await(a=>e.post("/biSetting/summarySetting/getDefaultColumn",a))(),{code:l,data:t}=a;l||(P.value=!1,F.value=K.tableName,G({tableName:K.tableName,columnList:t.columnList,refTableList:[{refTableName:void 0,joinType:void 0,refCondition:void 0,refTableAlias:"A"}]}))}}))},G=e=>{var a;H({id:e.id,tableName:e.tableName,refTableList:null==(a=e.refTableList)?void 0:a.map((e=>(D=D.filter((a=>a!==e.refTableAlias)),{refTableName:e.refTableName,joinType:e.joinType,refCondition:e.refCondition,refTableAlias:e.refTableAlias}))),columnList:e.columnList.map(((e,a)=>({id:N("summaryTableSet_"),columnName:e.columnName,handleType:e.handleType,summaryType:e.columnSummary??5,isKey:1===e.pkTag}))),timeCondition:e.timeCondition,groupCondition:e.groupCondition.replace("GROUP BY ",""),status:e.status,deleted:e.deleted})},Y=a(null),z=async()=>{if(await Y.value.validate()){const a=await(a=>e.post("/biSetting/summarySetting/save",a))({id:K.id,tableName:K.tableName,refTableList:K.refTableList,columnList:K.columnList.map((e=>({columnName:e.columnName,handleType:e.handleType,columnSummary:e.summaryType,pkTag:e.isKey?1:0}))),timeCondition:K.timeCondition,groupCondition:"GROUP BY "+K.groupCondition}),{code:l,data:t}=a;l||(g.success("保存成功"),K.id=t.id||K.id)}},J=async()=>{T.confirm({title:"提示",content:"是否停用该汇总表",onOk:async()=>{const e=await k({id:K.id,status:0}),{code:a,data:l}=e;a||(g.success(`汇总表${F.value}已停用`),K.status=0)}})},M=async()=>{T.confirm({title:"提示",content:"是否启用该汇总表",onOk:async()=>{const e=await k({id:K.id,status:1}),{code:a,data:l}=e;a||(g.success(`汇总表${F.value}已启用`),K.status=1)}})},E=()=>{K.refTableList.push({refTableName:"",joinType:1,refCondition:null,refTableAlias:D.shift()})};l((()=>{W(),Q(),new h(document.querySelector("#frontTableSetDragTable tbody"),{handle:".anticon-holder",animation:150,ghostClass:"blue-background-class",sort:!0,disabled:!1,async onEnd({newIndex:e,oldIndex:a}){const l=JSON.parse(JSON.stringify(K.columnList[a]));K.columnList.splice(a,1),K.columnList.splice(e,0,l)},onUpdate(e){}})}));const $=a([]),Q=async()=>{const a=await(a=>e.post("/biSetting/summarySetting/getHandleType",a))(),{code:l,data:t}=a;l||($.value=t)},V=a([]),W=async()=>{const a=await(a=>e.post("/biSetting/summarySetting/getSummaryType",a))(),{code:l,data:t}=a;l||(V.value=t)},X=[{title:"",dataIndex:"hold",width:20},{title:"列名",dataIndex:"columnName",key:"columnName",width:100,ellipsis:!0,editable:!0},{title:"处理方式",dataIndex:"handleType",key:"handleType",width:100,ellipsis:!0,editable:!0},{title:"列汇总",dataIndex:"summaryType",key:"summaryType",width:100,ellipsis:!0,editable:!0},{title:"",dataIndex:"action",key:"action",width:100,ellipsis:!0,editable:!0}];return(e,a)=>{const l=t("a-input"),T=t("a-button"),g=t("a-form-item"),h=t("a-select"),C=t("a-table"),k=t("a-form"),q=t("a-spin"),H=t("ListPage");return i(),n(H,null,{tableTitle:s((()=>[o("div",w,[S,d(l,{value:u(K).tableName,"onUpdate:value":a[0]||(a[0]=e=>u(K).tableName=e),valueModifiers:{trim:!0},placeholder:"请输入",style:{width:"300px"},allowClear:"",onKeyup:m(R,["enter"])},null,8,["value"]),d(T,{class:"ml-2",type:"primary",onClick:R,loading:P.value,disabled:!u(K).tableName},{default:s((()=>[r(" 检测 ")])),_:1},8,["loading","disabled"])])])),actions:s((()=>[o("div",L,[F.value?(i(),c("span",_," 当前操作表："+p(F.value),1)):y("",!0),d(T,{type:"primary",onClick:z,disabled:!F.value},{default:s((()=>[r(" 保存 ")])),_:1},8,["disabled"]),F.value&&1===u(K).status?(i(),n(T,{key:1,type:"primary",onClick:J},{default:s((()=>[r(" 停用 ")])),_:1})):y("",!0),F.value&&0===u(K).status?(i(),n(T,{key:2,type:"primary",onClick:M},{default:s((()=>[r(" 启用 ")])),_:1})):y("",!0)])])),table:s((({scrollHeight:e})=>[d(q,{spinning:P.value},{default:s((()=>[d(k,{ref_key:"frontTableRef",ref:Y,model:u(K),name:"formState","label-col":{style:"width: 100px"},autocomplete:"off"},{default:s((()=>[o("div",{class:"flex flex-col gap-2 py-2 border-t overflow-auto",style:v({maxHeight:e+"px"})},[o("div",null,[(i(!0),c(b,null,f(u(K).refTableList,((e,a)=>(i(),c("div",U,[d(g,{name:["refTableList",a,"refTableName"],label:0===a?"选择主表":"选择关联表：",rules:{required:!0,message:"请选择"}},{default:s((()=>[d(l,{value:e.refTableName,"onUpdate:value":a=>e.refTableName=a,valueModifiers:{trim:!0},placeholder:"请输入",style:{width:"300px"},allowClear:""},{addonAfter:s((()=>[o("span",A," 别名："+p(e.refTableAlias),1)])),_:2},1032,["value","onUpdate:value"])])),_:2},1032,["name","label"]),d(g,null,{default:s((()=>[a?(i(),n(T,{key:0,type:"text",danger:"",onClick:l=>((e,a)=>{D.push(a),D.sort(),K.refTableList.splice(e,1)})(a,e.refTableAlias)},{default:s((()=>[r("删除")])),_:2},1032,["onClick"])):y("",!0)])),_:2},1024)])))),256)),d(T,{type:"dashed",onClick:E,style:{width:"1100px","margin-left":"10px"},disabled:!F.value},{default:s((()=>[r(" + 新增关联表 ")])),_:1},8,["disabled"])]),o("div",I,[d(g,{label:"设置列内容："},{default:s((()=>[d(C,{id:"frontTableSetDragTable",size:"small",columns:X,"data-source":u(K).columnList,pagination:!1,"row-key":e=>e.id,class:"pr-4"},{bodyCell:s((({column:e,text:a,record:t,index:m})=>["hold"===e.dataIndex?(i(),n(g,{key:0},{default:s((()=>[d(u(x),{class:"hover:cursor-move"})])),_:1})):y("",!0),"action"===e.dataIndex?(i(),n(g,{key:1},{default:s((()=>[o("div",j,[d(T,{type:"text",style:{color:"#1890ff"},onClick:e=>(e=>{K.columnList.splice(e+1,0,{id:N("summaryTableSet_"),columnName:void 0,handleType:void 0,summaryType:5,isKey:!1})})(m)},{default:s((()=>[r(" 新增 ")])),_:2},1032,["onClick"]),d(T,{type:"text",danger:"",onClick:e=>(e=>{K.columnList.splice(e,1)})(m),disabled:1===u(K).columnList.length||t.isKey},{default:s((()=>[r(" 删除 ")])),_:2},1032,["onClick","disabled"])])])),_:2},1024)):y("",!0),"columnName"===e.dataIndex?(i(),n(g,{key:2,name:["columnList",m,"columnName"],rules:{required:!0,message:"请输入"}},{default:s((()=>[d(l,{placeholder:"请输入",value:t.columnName,"onUpdate:value":e=>t.columnName=e,disabled:t.isKey,allowClear:""},null,8,["value","onUpdate:value","disabled"])])),_:2},1032,["name"])):y("",!0),"handleType"===e.dataIndex?(i(),n(g,{key:3,name:["columnList",m,"handleType"],rules:{required:!0,message:"请选择"}},{default:s((()=>[d(h,{placeholder:"请选择",value:t.handleType,"onUpdate:value":e=>t.handleType=e,allowClear:"",options:V.value,fieldNames:{label:"name",value:"id"}},null,8,["value","onUpdate:value","options"])])),_:2},1032,["name"])):y("",!0),"summaryType"===e.dataIndex?(i(),n(g,{key:4,name:["columnList",m,"summaryType"]},{default:s((()=>[d(h,{placeholder:"请选择",value:t.summaryType,"onUpdate:value":e=>t.summaryType=e,allowClear:"",options:V.value,fieldNames:{label:"name",value:"id"}},null,8,["value","onUpdate:value","options"])])),_:2},1032,["name"])):y("",!0)])),_:1},8,["data-source","row-key"])])),_:1})]),o("div",O,[o("div",null,[d(g,{label:"时间条件：",name:"timeCondition",rules:{required:!0,message:"请输入"}},{default:s((()=>[d(l,{value:u(K).timeCondition,"onUpdate:value":a[1]||(a[1]=e=>u(K).timeCondition=e),placeholder:"请输入",style:{width:"600px"},allowClear:""},null,8,["value"])])),_:1})]),o("div",null,[d(g,{label:"整合条件：",name:"groupCondition",rules:{required:!0,message:"请输入"}},{default:s((()=>[d(l,{value:u(K).groupCondition,"onUpdate:value":a[2]||(a[2]=e=>u(K).groupCondition=e),placeholder:"请输入",style:{width:"600px"},allowClear:""},{addonBefore:s((()=>[r(" GROUP BY ")])),_:1},8,["value"])])),_:1})])])],4)])),_:2},1032,["model"])])),_:2},1032,["spinning"])])),_:1})}}};export{q as default};
